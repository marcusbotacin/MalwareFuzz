// LDPRELOAD implementation of randomized path exploration
// Marcus Botacin - UFPR - 2021

#define _GNU_SOURCE
#include <dlfcn.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<time.h>
#include <arpa/inet.h>

// Functions to be hooked
// Main/Init
static void init (void) __attribute__ ((constructor));
// Others
typedef long (*orig_ptrace_type)(int request, pid_t pid, void *addr, void *data);
typedef in_addr_t (*orig_inet_addr_type)(const char *cp);
typedef struct hostent* (*orig_gethostbyname_type)(const char *name);

// Global logger, as in Python, because I'm lazy
FILE *logger;

// init/main hook
static void init (void)
{
    // when starting the application, seed the rand
    srand(time(NULL));
    // open the log file
    logger = fopen("/tmp/log.txt","w");
    // and register analysis started
    fprintf(logger,"Started\n");
}

// Ptrace hook
long ptrace(int request, pid_t pid, void *addr, void *data)
{
    orig_ptrace_type orig_ptrace;
    orig_ptrace = (orig_ptrace_type)dlsym(RTLD_NEXT,__func__);
    // if not under random effects
    if((rand()%10)>=5)
    {
        // just register everything is fine
        fprintf(logger,"ptrace:ok\n");
    }else{
        // otherwise, return an error
        fprintf(logger,"ptrace:fail\n");
        return -1;
    }
    // when succeding, we need to actually call the original ptrace
    return orig_ptrace(request,pid,addr,data);
}

// addr hook
in_addr_t inet_addr(const char *cp)
{
    orig_inet_addr_type orig_inet;
    orig_inet = (orig_inet_addr_type)dlsym(RTLD_NEXT,__func__);
    // we just want to know that this was called
    // it is a "malicious" behavior
    fprintf(logger,"inet:%s:ok\n",cp);
    return orig_inet(cp);
}

// gethostbyname hook
struct hostent* gethostbyname(const char *name)
{
    orig_gethostbyname_type orig_gethostbyname;
    orig_gethostbyname = (orig_gethostbyname_type)dlsym(RTLD_NEXT,__func__);
    if((rand()%10)>=5)
    {
        fprintf(logger,"gethostbyname:%s:ok\n",name);
    }else{
        fprintf(logger,"gethostbyname:%s:fail\n",name);
        // failure
        return NULL;
    }
    // success
    return orig_gethostbyname(name);
}
