import sys
import argparse
import requests
import bs4
import re
import logging
import pickle

api_name = sys.argv[1].lower()
url = 'https://docs.microsoft.com/api/search?search=%s&locale=en-us&scope=Desktop'
r =  requests.get(url % api_name)
_url = None
for res in r.json()['results']:
    look_for = "%s function" % api_name
    #print(look_for,res['title'].lower())
    if look_for in res['title'].lower():
        _url = res['url']
if _url is None:
    print("API function not found")
    sys.exit(0)
#_url = r.json()['results'][0]['url']
r = requests.get(_url)
s = bs4.BeautifulSoup(r.text,'html.parser')
#print(s)
f = s.find("code")
t = f.get_text()
print(t)
print("-----")
#x = s.find("meta", attrs={'name': 'req.header'})
x = s.find("meta", attrs={'name': 'req.include-header'})
print("#include<%s>" % x['content'])
args2 = ''.join([x.strip().split(" ")[-1] for x in t.split("(")[1].split(")")[0].strip().split("\n")])
#print(args)

ret = t.split(" ")[0]
#name = t.split(" ")[1].split("(")[0]
name = t.split("(")[0].split(" ")[-1]
args = t.split("(")[1].replace(";","")
hooked = "%s __stdcall My%s(%s{\n\tfprintf(log,\"%s\\n\");\n\treturn %s(%s);\n}" % (ret,name,args,name,name,args2)
print hooked

lib = s.find("meta", attrs={'name': 'req.lib'})['content'].split(".")[0]
print("{\"%s\",\"%s\",My%s}," % (lib,name,name))
